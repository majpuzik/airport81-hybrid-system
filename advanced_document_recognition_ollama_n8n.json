{
  "name": "Advanced Document Recognition for Paperless-ngx",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "trigger",
      "name": "Check Emails",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        200,
        400
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "message",
        "operation": "getAll",
        "q": "is:unread",
        "format": "full",
        "additionalFields": {
          "maxResults": 50
        }
      },
      "id": "gmail",
      "name": "Gmail Messages",
      "type": "n8n-nodes-base.gmail",
      "position": [
        400,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// KROK 1: Filtrovat reklamnÃ­ a marketingovÃ© emaily\nconst spamKeywords = [\n  // Marketing\n  'unsubscribe', 'odhlÃ¡sit', 'newsletter', 'marketing',\n  'promo', 'sale', 'sleva', 'akce', 'vÃ½prodej', 'discount',\n  'limited offer', 'special offer', 'nabÃ­dka dne',\n  \n  // Spam indikÃ¡tory\n  'click here', 'kliknÄ›te zde', 'act now', 'jednejte nynÃ­',\n  'free', 'zdarma', 'win', 'vyhrajte', 'congratulations',\n  \n  // Social media\n  'facebook', 'instagram', 'linkedin', 'twitter',\n  'social media', 'follow us', 'sledujte nÃ¡s'\n];\n\nconst trustedDomains = [\n  // Banky\n  'csob.cz', 'kb.cz', 'csas.cz', 'moneta.cz', 'airbank.cz',\n  'fio.cz', 'mbank.cz', 'unicreditbank.cz', 'revolut.com',\n  \n  // DodavatelÃ© energie\n  'cez.cz', 'eon.cz', 'pre.cz', 'innogy.cz',\n  \n  // Telco\n  'o2.cz', 't-mobile.cz', 'vodafone.cz',\n  \n  // ZnÃ¡mÃ© firmy\n  'alza.cz', 'mall.cz', 'rohlik.cz'\n];\n\nconst items = [];\n\nfor (const item of $input.all()) {\n  const email = item.json;\n  const headers = email.payload?.headers || [];\n  \n  // ZÃ­skat dÅ¯leÅ¾itÃ© hlaviÄky\n  const subject = headers.find(h => h.name === 'Subject')?.value || '';\n  const from = headers.find(h => h.name === 'From')?.value || '';\n  const to = headers.find(h => h.name === 'To')?.value || '';\n  const returnPath = headers.find(h => h.name === 'Return-Path')?.value || '';\n  const listUnsubscribe = headers.find(h => h.name === 'List-Unsubscribe')?.value;\n  \n  // Extrahovat domÃ©nu odesÃ­latele\n  const fromDomain = from.match(/@([^\\s>]+)/)?.[1]?.toLowerCase() || '';\n  \n  // SkÃ³re pro spam (0-100, vyÅ¡Å¡Ã­ = vÃ­ce spam)\n  let spamScore = 0;\n  const spamReasons = [];\n  \n  // 1. List-Unsubscribe header = tÃ©mÄ›Å™ jistÄ› marketing\n  if (listUnsubscribe) {\n    spamScore += 40;\n    spamReasons.push('Has unsubscribe header');\n  }\n  \n  // 2. Kontrola spam keywords\n  const textToCheck = (subject + ' ' + from).toLowerCase();\n  for (const keyword of spamKeywords) {\n    if (textToCheck.includes(keyword.toLowerCase())) {\n      spamScore += 15;\n      spamReasons.push(`Contains: ${keyword}`);\n    }\n  }\n  \n  // 3. No-reply adresy\n  if (from.toLowerCase().includes('no-reply') || from.toLowerCase().includes('noreply')) {\n    spamScore += 25;\n    spamReasons.push('No-reply address');\n  }\n  \n  // 4. DÅ¯vÄ›ryhodnÃ© domÃ©ny sniÅ¾ujÃ­ skÃ³re\n  if (trustedDomains.some(domain => fromDomain.includes(domain))) {\n    spamScore -= 30;\n    spamReasons.push('Trusted domain');\n  }\n  \n  // 5. Return-Path nesouhlasÃ­ s From\n  const returnDomain = returnPath.match(/@([^\\s>]+)/)?.[1]?.toLowerCase() || '';\n  if (returnDomain && returnDomain !== fromDomain) {\n    spamScore += 20;\n    spamReasons.push('Return-path mismatch');\n  }\n  \n  // PÅ™idat analÃ½zu\n  email.spamAnalysis = {\n    score: Math.max(0, Math.min(100, spamScore)),\n    reasons: spamReasons,\n    fromDomain: fromDomain,\n    isSpam: spamScore > 50,\n    isTrusted: trustedDomains.some(domain => fromDomain.includes(domain))\n  };\n  \n  // PÅ™idat zÃ¡kladnÃ­ metadata\n  email.metadata = {\n    subject,\n    from,\n    fromDomain,\n    to,\n    date: headers.find(h => h.name === 'Date')?.value,\n    messageId: email.id\n  };\n  \n  items.push({json: email});\n}\n\nreturn items;"
      },
      "id": "spamFilter",
      "name": "Spam & Marketing Filter",
      "type": "n8n-nodes-base.code",
      "position": [
        600,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "leftValue": "={{ $json.spamAnalysis.isSpam }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "filterSpam",
      "name": "Remove Spam",
      "type": "n8n-nodes-base.filter",
      "position": [
        800,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// KROK 2: Extrakce a analÃ½za pÅ™Ã­loh\nconst items = [];\n\nfor (const item of $input.all()) {\n  const email = item.json;\n  const attachments = [];\n  \n  // Funkce pro dekÃ³dovÃ¡nÃ­ base64 nÃ¡zvu souboru\n  function decodeFilename(filename) {\n    if (filename.startsWith('=?') && filename.endsWith('?=')) {\n      // RFC 2047 encoded filename\n      const match = filename.match(/=\\?(.+?)\\?([BQ])\\?(.+?)\\?=/i);\n      if (match) {\n        const charset = match[1];\n        const encoding = match[2].toUpperCase();\n        const encoded = match[3];\n        \n        if (encoding === 'B') {\n          return Buffer.from(encoded, 'base64').toString('utf8');\n        } else if (encoding === 'Q') {\n          return encoded.replace(/_/g, ' ').replace(/=([0-9A-F]{2})/gi, \n            (match, hex) => String.fromCharCode(parseInt(hex, 16)));\n        }\n      }\n    }\n    return filename;\n  }\n  \n  // ProchÃ¡zet ÄÃ¡sti emailu\n  function processEmailParts(parts, parentMimeType = '') {\n    if (!parts) return;\n    \n    for (const part of parts) {\n      // RekurzivnÄ› zpracovat vnoÅ™enÃ© ÄÃ¡sti\n      if (part.parts) {\n        processEmailParts(part.parts, part.mimeType);\n      }\n      \n      // Je to pÅ™Ã­loha?\n      if (part.filename && part.filename !== '') {\n        const decodedFilename = decodeFilename(part.filename);\n        const extension = decodedFilename.split('.').pop().toLowerCase();\n        \n        attachments.push({\n          filename: decodedFilename,\n          originalFilename: part.filename,\n          mimeType: part.mimeType,\n          size: part.body?.size || 0,\n          attachmentId: part.body?.attachmentId,\n          extension: extension,\n          // Kategorizace podle typu\n          category: categorizeByExtension(extension),\n          needsOCR: ['pdf', 'jpg', 'jpeg', 'png', 'tiff', 'bmp'].includes(extension)\n        });\n      }\n    }\n  }\n  \n  function categorizeByExtension(ext) {\n    const categories = {\n      'pdf': 'document',\n      'doc': 'document', 'docx': 'document',\n      'xls': 'spreadsheet', 'xlsx': 'spreadsheet', 'csv': 'spreadsheet',\n      'xml': 'data', 'json': 'data',\n      'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'tiff': 'image',\n      'eml': 'email', 'msg': 'email',\n      'zip': 'archive', 'rar': 'archive', '7z': 'archive',\n      'p7s': 'signature', 'p7m': 'signed'\n    };\n    return categories[ext] || 'other';\n  }\n  \n  // Zpracovat email ÄÃ¡sti\n  if (email.payload?.parts) {\n    processEmailParts(email.payload.parts);\n  }\n  \n  // ZÃ­skat text emailu pro analÃ½zu\n  let emailText = '';\n  function extractText(parts) {\n    if (!parts) return;\n    for (const part of parts) {\n      if (part.mimeType === 'text/plain' && part.body?.data) {\n        emailText += Buffer.from(part.body.data, 'base64').toString('utf8') + '\\n';\n      } else if (part.parts) {\n        extractText(part.parts);\n      }\n    }\n  }\n  \n  if (email.payload?.parts) {\n    extractText(email.payload.parts);\n  } else if (email.payload?.body?.data) {\n    emailText = Buffer.from(email.payload.body.data, 'base64').toString('utf8');\n  }\n  \n  // PÅ™idat vÃ½sledky\n  email.attachmentAnalysis = {\n    hasAttachments: attachments.length > 0,\n    attachmentCount: attachments.length,\n    attachments: attachments,\n    documentAttachments: attachments.filter(a => a.category === 'document'),\n    needsOCR: attachments.some(a => a.needsOCR)\n  };\n  \n  email.emailText = emailText.substring(0, 5000); // Limit textu\n  \n  items.push({json: email});\n}\n\nreturn items;"
      },
      "id": "attachmentAnalysis",
      "name": "Attachment Analysis",
      "type": "n8n-nodes-base.code",
      "position": [
        1000,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// KROK 3: PÅ™edbÄ›Å¾nÃ¡ klasifikace dokumentÅ¯ podle obsahu emailu\nconst documentPatterns = {\n  'faktura': {\n    keywords: [\n      'faktura', 'invoice', 'daÅˆovÃ½ doklad', 'tax invoice',\n      'fakturujeme', 'vyÃºÄtovÃ¡nÃ­', 'platba za', 'ÃºÄtujeme'\n    ],\n    identifiers: [\n      /faktura\\s*Ä\\.?\\s*\\d+/i,\n      /invoice\\s*no\\.?\\s*\\d+/i,\n      /variabilnÃ­ symbol/i,\n      /iÄo:\\s*\\d+/i,\n      /diÄ:\\s*CZ\\d+/i\n    ],\n    confidence: 0.9\n  },\n  'proforma': {\n    keywords: [\n      'proforma', 'pro forma', 'pro-forma', 'zÃ¡lohovÃ¡ faktura',\n      'pÅ™edfaktura', 'draft invoice'\n    ],\n    identifiers: [\n      /proforma\\s*Ä\\.?\\s*\\d+/i,\n      /nenÃ­\\s*daÅˆovÃ½\\s*doklad/i\n    ],\n    confidence: 0.85\n  },\n  'platba': {\n    keywords: [\n      'potvrzenÃ­ o platbÄ›', 'payment confirmation', 'platba pÅ™ijata',\n      'uhrazeno', 'zaplaceno', 'payment received'\n    ],\n    identifiers: [\n      /platba\\s*ve\\s*vÃ½Å¡i/i,\n      /pÅ™ipsÃ¡no\\s*na\\s*ÃºÄet/i,\n      /transaction\\s*id/i\n    ],\n    confidence: 0.9\n  },\n  'bankovni_vypis': {\n    keywords: [\n      'vÃ½pis z ÃºÄtu', 'bank statement', 'vÃ½pis z bankovnÃ­ho ÃºÄtu',\n      'account statement', 'mÄ›sÃ­ÄnÃ­ vÃ½pis'\n    ],\n    identifiers: [\n      /vÃ½pis\\s*Ä\\.?\\s*\\d+/i,\n      /obdobÃ­\\s*od.*do/i,\n      /poÄÃ¡teÄnÃ­\\s*zÅ¯statek/i,\n      /koneÄnÃ½\\s*zÅ¯statek/i\n    ],\n    confidence: 0.95\n  },\n  'potvrzeni_prevodu': {\n    keywords: [\n      'potvrzenÃ­ o pÅ™evodu', 'transfer confirmation', 'pÅ™Ã­kaz k ÃºhradÄ›',\n      'payment order', 'pÅ™evod prostÅ™edkÅ¯'\n    ],\n    identifiers: [\n      /z\\s*ÃºÄtu.*na\\s*ÃºÄet/i,\n      /IBAN/i,\n      /BIC|SWIFT/i\n    ],\n    confidence: 0.85\n  },\n  'smlouva': {\n    keywords: [\n      'smlouva', 'contract', 'agreement', 'dohoda',\n      'smluvnÃ­ strany', 'uzavÅ™eli', 'terms and conditions'\n    ],\n    identifiers: [\n      /ÄlÃ¡nek\\s*\\d+/i,\n      /smluvnÃ­\\s*strany/i,\n      /platnost\\s*smlouvy/i,\n      /podpis/i\n    ],\n    confidence: 0.8\n  },\n  'objednavka': {\n    keywords: [\n      'objednÃ¡vka', 'order', 'purchase order', 'nÃ¡kupnÃ­ objednÃ¡vka',\n      'objednÃ¡vÃ¡me', 'order confirmation'\n    ],\n    identifiers: [\n      /objednÃ¡vka\\s*Ä\\.?\\s*\\d+/i,\n      /order\\s*no\\.?\\s*\\d+/i,\n      /dodacÃ­\\s*lhÅ¯ta/i\n    ],\n    confidence: 0.85\n  },\n  'dodaci_list': {\n    keywords: [\n      'dodacÃ­ list', 'delivery note', 'packing list',\n      'expedice', 'pÅ™evzal', 'doruÄeno'\n    ],\n    identifiers: [\n      /dodacÃ­\\s*list\\s*Ä\\.?\\s*\\d+/i,\n      /datum\\s*dodÃ¡nÃ­/i,\n      /pÅ™evzal/i\n    ],\n    confidence: 0.8\n  }\n};\n\nconst items = [];\n\nfor (const item of $input.all()) {\n  const email = item.json;\n  const textToAnalyze = (\n    email.metadata.subject + ' ' + \n    email.emailText + ' ' +\n    email.attachmentAnalysis.attachments.map(a => a.filename).join(' ')\n  ).toLowerCase();\n  \n  // Analyzovat kaÅ¾dÃ½ typ dokumentu\n  const classifications = [];\n  \n  for (const [docType, pattern] of Object.entries(documentPatterns)) {\n    let score = 0;\n    const matches = [];\n    \n    // Kontrola klÃ­ÄovÃ½ch slov\n    for (const keyword of pattern.keywords) {\n      if (textToAnalyze.includes(keyword.toLowerCase())) {\n        score += 0.3;\n        matches.push(`keyword: ${keyword}`);\n      }\n    }\n    \n    // Kontrola identifikÃ¡torÅ¯ (regex)\n    for (const identifier of pattern.identifiers) {\n      if (identifier.test(textToAnalyze)) {\n        score += 0.5;\n        matches.push(`pattern: ${identifier.source}`);\n      }\n    }\n    \n    // PÅ™idat klasifikaci pokud je skÃ³re dostateÄnÃ©\n    if (score > 0) {\n      classifications.push({\n        type: docType,\n        score: Math.min(score, 1),\n        confidence: score * pattern.confidence,\n        matches: matches\n      });\n    }\n  }\n  \n  // SeÅ™adit podle confidence\n  classifications.sort((a, b) => b.confidence - a.confidence);\n  \n  // UrÄit primÃ¡rnÃ­ typ dokumentu\n  const primaryType = classifications[0]?.confidence > 0.5 ? classifications[0].type : 'unknown';\n  \n  email.documentClassification = {\n    primaryType: primaryType,\n    confidence: classifications[0]?.confidence || 0,\n    allClassifications: classifications,\n    needsManualReview: classifications[0]?.confidence < 0.7\n  };\n  \n  items.push({json: email});\n}\n\nreturn items;"
      },
      "id": "documentClassification",
      "name": "Document Type Classification",
      "type": "n8n-nodes-base.code",
      "position": [
        1200,
        300
      ]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "downloadAttachment",
        "messageId": "={{ $json.metadata.messageId }}",
        "attachmentId": "={{ $json.attachmentAnalysis.documentAttachments[0].attachmentId }}"
      },
      "id": "downloadAttachment",
      "name": "Download Document",
      "type": "n8n-nodes-base.gmail",
      "position": [
        1400,
        300
      ]
    },
    {
      "parameters": {
        "mode": "passThrough",
        "output": "both",
        "assignments": {
          "assignments": [
            {
              "id": "fileData",
              "name": "fileData",
              "type": "string",
              "value": "={{ $json.data }}"
            }
          ]
        }
      },
      "id": "prepareFile",
      "name": "Prepare File Data",
      "type": "n8n-nodes-base.set",
      "position": [
        1600,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:11434/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"llama3.3:70b\",\n  \"prompt\": \"Jsi expert na analÃ½zu business dokumentÅ¯. TvÃ½m Ãºkolem je PÅ˜ESNÄš urÄit typ dokumentu a extrahovat klÃ­ÄovÃ© informace.\\n\\nTYPY DOKUMENTÅ® kterÃ© musÃ­Å¡ rozpoznat:\\n1. FAKTURA - daÅˆovÃ½ doklad s IÄŒO, DIÄŒ, ÄÃ¡stkou k ÃºhradÄ›\\n2. PROFORMA - pÅ™edfaktura, nenÃ­ daÅˆovÃ½ doklad\\n3. BANKOVNÃ VÃPIS - vÃ½pis z ÃºÄtu s transakcemi\\n4. POTVRZENÃ O PLATBÄš - potvrzenÃ­ o pÅ™ijatÃ©/odeslanÃ© platbÄ›\\n5. POTVRZENÃ O PÅ˜EVODU - potvrzenÃ­ bankovnÃ­ho pÅ™evodu\\n6. SMLOUVA - prÃ¡vnÃ­ dokument s podmÃ­nkami\\n7. OBJEDNÃVKA - objednÃ¡vka zboÅ¾Ã­/sluÅ¾eb\\n8. DODACÃ LIST - potvrzenÃ­ o dodÃ¡nÃ­\\n9. UPOMÃNKA - upomÃ­nka k platbÄ›\\n10. JINÃ - pokud nespadÃ¡ do vÃ½Å¡e uvedenÃ½ch\\n\\nAnalyzuj tento dokument:\\nNÃ¡zev souboru: {{ $('attachmentAnalysis').item.json.attachmentAnalysis.documentAttachments[0].filename }}\\nPÅ™edbÄ›Å¾nÃ¡ klasifikace: {{ $('documentClassification').item.json.documentClassification.primaryType }}\\nObsah emailu:\\n{{ $('documentClassification').item.json.emailText }}\\n\\nVRAÅ¤ POUZE JSON bez dalÅ¡Ã­ho textu:\\n{\\n  \\\"documentType\\\": \\\"pÅ™esnÃ½_typ\\\",\\n  \\\"confidence\\\": 0.0-1.0,\\n  \\\"vendor\\\": \\\"nÃ¡zev_dodavatele\\\",\\n  \\\"documentNumber\\\": \\\"ÄÃ­slo_dokumentu\\\",\\n  \\\"date\\\": \\\"datum_vystavenÃ­\\\",\\n  \\\"amount\\\": ÄÃ­slo_nebo_null,\\n  \\\"currency\\\": \\\"CZK/EUR/USD\\\",\\n  \\\"variableSymbol\\\": \\\"VS_pokud_existuje\\\",\\n  \\\"dueDate\\\": \\\"datum_splatnosti\\\",\\n  \\\"extractedData\\\": {}\\n}\",\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": 0.1,\n    \"num_predict\": 1000\n  }\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "ollamaAnalysis",
      "name": "Ollama Document Analysis (70B)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1800,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// KROK 4: FinÃ¡lnÃ­ klasifikace a pÅ™Ã­prava pro Paperless-ngx\nconst item = $input.first();\nconst email = item.json;\n// Zpracovat Ollama odpovÄ›Ä\nconst ollamaResponse = $('ollamaAnalysis').first().json;\nlet aiAnalysis = {};\ntry {\n  // Ollama vracÃ­ JSON v poli 'response'\n  const responseText = ollamaResponse.response || ollamaResponse.choices?.[0]?.message?.content || '{}';\n  aiAnalysis = JSON.parse(responseText);\n} catch (e) {\n  console.error('Failed to parse Ollama response:', e);\n  aiAnalysis = {};\n}\n\n// MapovÃ¡nÃ­ typÅ¯ dokumentÅ¯ na Paperless-ngx tagy\nconst paperlessTags = {\n  'faktura': ['invoice', 'financial', 'unpaid'],\n  'proforma': ['proforma', 'financial', 'draft'],\n  'bankovni_vypis': ['bank-statement', 'financial', 'monthly'],\n  'potvrzeni_platba': ['payment-confirmation', 'financial', 'paid'],\n  'potvrzeni_prevod': ['transfer-confirmation', 'financial'],\n  'smlouva': ['contract', 'legal', 'important'],\n  'objednavka': ['purchase-order', 'procurement'],\n  'dodaci_list': ['delivery-note', 'logistics'],\n  'upominka': ['payment-reminder', 'urgent', 'unpaid']\n};\n\n// UrÄit finÃ¡lnÃ­ typ dokumentu\nconst finalType = aiAnalysis.documentType || email.documentClassification.primaryType;\nconst tags = paperlessTags[finalType] || ['unclassified'];\n\n// PÅ™idat dodavatele jako tag pokud existuje\nif (aiAnalysis.vendor) {\n  tags.push(aiAnalysis.vendor.toLowerCase().replace(/\\s+/g, '-'));\n}\n\n// PÅ™idat rok jako tag\nif (aiAnalysis.date) {\n  const year = new Date(aiAnalysis.date).getFullYear();\n  tags.push(`year-${year}`);\n}\n\n// VytvoÅ™it titulek pro Paperless\nlet title = '';\nif (aiAnalysis.documentNumber) {\n  title = `${aiAnalysis.vendor || 'Unknown'} - ${finalType} ${aiAnalysis.documentNumber}`;\n} else {\n  title = `${aiAnalysis.vendor || email.metadata.fromDomain} - ${finalType} - ${aiAnalysis.date || new Date().toISOString().split('T')[0]}`;\n}\n\n// VytvoÅ™it metadata pro Paperless-ngx\nconst paperlessDocument = {\n  title: title,\n  correspondent: aiAnalysis.vendor || email.metadata.fromDomain,\n  document_type: finalType,\n  tags: tags,\n  created_date: aiAnalysis.date || email.metadata.date,\n  // Custom fields\n  custom_fields: {\n    amount: aiAnalysis.amount,\n    currency: aiAnalysis.currency,\n    variable_symbol: aiAnalysis.variableSymbol,\n    due_date: aiAnalysis.dueDate,\n    document_number: aiAnalysis.documentNumber,\n    email_from: email.metadata.from,\n    email_subject: email.metadata.subject,\n    confidence_score: aiAnalysis.confidence || email.documentClassification.confidence\n  },\n  // PÅ¯vodnÃ­ soubor\n  file_data: email.fileData,\n  filename: email.attachmentAnalysis.documentAttachments[0].filename\n};\n\n// UrÄit prioritu pro zpracovÃ¡nÃ­\nlet priority = 'normal';\nif (finalType === 'upominka') priority = 'urgent';\nelse if (finalType === 'faktura' && aiAnalysis.dueDate) {\n  const dueDate = new Date(aiAnalysis.dueDate);\n  const today = new Date();\n  const daysUntilDue = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));\n  if (daysUntilDue < 7) priority = 'high';\n}\n\nreturn {\n  json: {\n    ...email,\n    finalClassification: {\n      type: finalType,\n      confidence: aiAnalysis.confidence || email.documentClassification.confidence,\n      aiAnalysis: aiAnalysis,\n      tags: tags,\n      priority: priority\n    },\n    paperlessDocument: paperlessDocument\n  }\n};"
      },
      "id": "preparePaperless",
      "name": "Prepare for Paperless-ngx",
      "type": "n8n-nodes-base.code",
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://paperless-ngx:8000/api/documents/",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "multipart/form-data"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "title",
              "value": "={{ $json.paperlessDocument.title }}"
            },
            {
              "name": "correspondent",
              "value": "={{ $json.paperlessDocument.correspondent }}"
            },
            {
              "name": "document_type",
              "value": "={{ $json.paperlessDocument.document_type }}"
            },
            {
              "name": "tags",
              "value": "={{ $json.paperlessDocument.tags.join(',') }}"
            },
            {
              "name": "created",
              "value": "={{ $json.paperlessDocument.created_date }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "uploadToPaperless",
      "name": "Upload to Paperless-ngx",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2200,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "paperlessAuth",
          "name": "Paperless-ngx API"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "addLabel",
        "messageId": "={{ $json.metadata.messageId }}",
        "labelIds": [
          "Processed",
          "{{ $json.finalClassification.type }}"
        ]
      },
      "id": "markAsProcessed",
      "name": "Mark Email as Processed",
      "type": "n8n-nodes-base.gmail",
      "position": [
        2400,
        300
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "summary",
              "value": "=ðŸ“„ Dokument zpracovÃ¡n\\n\\nTyp: {{ $json.finalClassification.type }}\\nDodavatel: {{ $json.paperlessDocument.correspondent }}\\nÄŒÃ­slo: {{ $json.paperlessDocument.custom_fields.document_number }}\\nÄŒÃ¡stka: {{ $json.paperlessDocument.custom_fields.amount }} {{ $json.paperlessDocument.custom_fields.currency }}\\nSplatnost: {{ $json.paperlessDocument.custom_fields.due_date }}\\nPriorita: {{ $json.finalClassification.priority }}\\nJistota: {{ $json.finalClassification.confidence }}\\n\\nTagy: {{ $json.paperlessDocument.tags.join(', ') }}"
            }
          ]
        }
      },
      "id": "createSummary",
      "name": "Create Summary",
      "type": "n8n-nodes-base.set",
      "position": [
        2600,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "webhook",
        "channel": "#documents",
        "text": "={{ $json.summary }}",
        "otherOptions": {
          "attachments": {
            "attachments": [
              {
                "color": "={{ $json.finalClassification.priority === 'urgent' ? '#ff0000' : $json.finalClassification.priority === 'high' ? '#ff9900' : '#36a64f' }}",
                "fields": {
                  "item": [
                    {
                      "short": true,
                      "title": "Dokument",
                      "value": "{{ $json.paperlessDocument.title }}"
                    },
                    {
                      "short": true,
                      "title": "Stav",
                      "value": "âœ… UloÅ¾eno do Paperless-ngx"
                    }
                  ]
                }
              }
            ]
          }
        }
      },
      "id": "notifySlack",
      "name": "Notify Slack",
      "type": "n8n-nodes-base.slack",
      "position": [
        2800,
        300
      ]
    }
  ],
  "connections": {
    "trigger": {
      "main": [
        [
          {
            "node": "gmail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gmail": {
      "main": [
        [
          {
            "node": "spamFilter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "spamFilter": {
      "main": [
        [
          {
            "node": "filterSpam",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filterSpam": {
      "main": [
        [
          {
            "node": "attachmentAnalysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "attachmentAnalysis": {
      "main": [
        [
          {
            "node": "documentClassification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "documentClassification": {
      "main": [
        [
          {
            "node": "downloadAttachment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "downloadAttachment": {
      "main": [
        [
          {
            "node": "prepareFile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepareFile": {
      "main": [
        [
          {
            "node": "ollamaAnalysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "preparePaperless": {
      "main": [
        [
          {
            "node": "uploadToPaperless",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "uploadToPaperless": {
      "main": [
        [
          {
            "node": "markAsProcessed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "markAsProcessed": {
      "main": [
        [
          {
            "node": "createSummary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "createSummary": {
      "main": [
        [
          {
            "node": "notifySlack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ollamaAnalysis": {
      "main": [
        [
          {
            "node": "preparePaperless",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}