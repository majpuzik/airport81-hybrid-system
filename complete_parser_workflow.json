{
  "name": "PDF Complete Parser",
  "nodes": [
    {
      "parameters": {},
      "id": "manual",
      "name": "Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "command": "ls /Users/m.a.j.puzik/Desktop/*.pdf 2>/dev/null | head -5"
      },
      "id": "listPdfs",
      "name": "List PDFs",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "jsCode": "const files = ($json.stdout || '').split('\\n').filter(f => f.trim());\n\nif (files.length === 0) {\n  throw new Error('No PDF files found');\n}\n\nconst FILE_NUMBER = 1;\nconst selectedFile = files[FILE_NUMBER - 1];\n\nconsole.log('Selected: ' + selectedFile);\n\nreturn [{json: {\n  filepath: selectedFile,\n  filename: selectedFile.split('/').pop()\n}}];"
      },
      "id": "selectFile",
      "name": "Select File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 300]
    },
    {
      "parameters": {
        "command": "=base64 -i '{{$json.filepath}}' -o -"
      },
      "id": "base64encode",
      "name": "Base64 Encode",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [800, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "https://api.pdf.co/v1/pdf/convert/to/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "puzik@outlook.com_jBTKYojSItt25GcgtQakogOdYCwf63GXQDKUW46uhRQmJStwMG4ozND282mVn6Bf"
            }
          ]
        },
        "sendBody": true,
        "bodyType": "json",
        "jsonBody": "={\"file\": \"data:application/pdf;base64,{{$json.stdout.replace(/\\n/g, '')}}\", \"inline\": true}",
        "options": {}
      },
      "id": "pdfcoExtract",
      "name": "PDFco Extract",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1000, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const filepath = $node['selectFile'].json.filepath;\nconst filename = $node['selectFile'].json.filename;\n\nif ($json.error) {\n  return [{json: {\n    status: 'ERROR',\n    message: $json.message || 'PDF.co failed',\n    filename: filename\n  }}];\n}\n\nconst text = ($json.body || $json.text || '');\nconst textLower = text.toLowerCase();\n\n// KLASIFIKACE TYPU DOKUMENTU\nlet docType = 'unknown';\nif (textLower.includes('faktura') || textLower.includes('invoice')) docType = 'faktura';\nelse if (textLower.includes('√∫ƒçtenka') || textLower.includes('uctenka') || textLower.includes('receipt')) docType = 'uctenka';\nelse if (textLower.includes('v√Ωpis') || textLower.includes('vypis') || textLower.includes('statement')) docType = 'vypis';\nelse if (textLower.includes('smlouva') || textLower.includes('contract')) docType = 'smlouva';\nelse if (textLower.includes('√∫≈ôedn√≠') || textLower.includes('urednik') || textLower.includes('official')) docType = 'urednik';\n\n// NAJIT KORESPONDENTA\nlet correspondent = 'Unknown';\nif (textLower.includes('ƒçsob') || textLower.includes('csob')) correspondent = 'CSOB';\nelse if (textLower.includes('komerƒçn√≠ banka') || textLower.includes('komercni banka')) correspondent = 'Komercni banka';\nelse if (textLower.includes('ƒçesk√° spo≈ôitelna') || textLower.includes('ceska sporitelna')) correspondent = 'Ceska sporitelna';\nelse if (textLower.includes('raiffeisenbank')) correspondent = 'Raiffeisenbank';\nelse if (textLower.includes('moneta')) correspondent = 'Moneta';\nelse if (textLower.includes('alza')) correspondent = 'Alza';\nelse if (textLower.includes('lidl')) correspondent = 'Lidl';\nelse if (textLower.includes('kaufland')) correspondent = 'Kaufland';\nelse if (textLower.includes('tesco')) correspondent = 'Tesco';\nelse if (textLower.includes('amazon')) correspondent = 'Amazon';\n\n// PARSOVANI SPECIFICKYCH UDAJU PODLE TYPU\nconst customFields = {};\nconst tags = [docType];\n\nif (correspondent !== 'Unknown') {\n  tags.push(correspondent.toLowerCase().replace(/\\s+/g, '-'));\n}\n\n// PARSOVANI PRO FAKTURU\nif (docType === 'faktura') {\n  // ICO\n  const icoMatch = text.match(/IƒåO?:?\\s*(\\d{8})/i);\n  if (icoMatch) {\n    customFields.ico = icoMatch[1];\n    tags.push('ico-' + icoMatch[1]);\n  }\n  \n  // DIC\n  const dicMatch = text.match(/DIƒå:?\\s*(CZ\\d{8,10})/i);\n  if (dicMatch) {\n    customFields.dic = dicMatch[1];\n    tags.push('dic-' + dicMatch[1].toLowerCase());\n  }\n  \n  // Cislo faktury\n  const invoiceMatch = text.match(/(?:ƒç√≠slo faktury|invoice number|faktura ƒç\\.?):?\\s*([A-Z0-9\\-\\/]+)/i);\n  if (invoiceMatch) {\n    customFields.invoice_number = invoiceMatch[1];\n  }\n  \n  // Variabilni symbol\n  const vsMatch = text.match(/(?:VS|variabiln√≠ symbol):?\\s*(\\d+)/i);\n  if (vsMatch) {\n    customFields.variable_symbol = vsMatch[1];\n    tags.push('vs-' + vsMatch[1]);\n  }\n  \n  // Castka\n  const amountMatch = text.match(/(?:celkem k √∫hradƒõ|celkem|total|k √∫hradƒõ):?\\s*([\\d\\s]+[,.]?\\d*)\\s*(?:Kƒç|CZK|EUR)/i);\n  if (amountMatch) {\n    customFields.amount = amountMatch[1].replace(/\\s/g, '');\n    const amount = parseFloat(amountMatch[1].replace(/\\s/g, '').replace(',', '.'));\n    if (amount > 10000) tags.push('velka-faktura');\n    else tags.push('mala-faktura');\n  }\n  \n  // Datum vystaveni\n  const dateMatch = text.match(/(?:datum vystaven√≠|date of issue|vystaveno):?\\s*(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})/i);\n  if (dateMatch) {\n    customFields.issue_date = dateMatch[1];\n  }\n  \n  // Datum splatnosti\n  const dueMatch = text.match(/(?:datum splatnosti|due date|splatnost):?\\s*(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})/i);\n  if (dueMatch) {\n    customFields.due_date = dueMatch[1];\n  }\n}\n\n// PARSOVANI PRO BANKOVNI VYPIS\nif (docType === 'vypis') {\n  // Cislo uctu\n  const accountMatch = text.match(/(?:ƒç√≠slo √∫ƒçtu|account number|ƒç\\.√∫\\.):?\\s*([\\d\\-\\/]+)/i);\n  if (accountMatch) {\n    customFields.account_number = accountMatch[1];\n  }\n  \n  // Obdobi\n  const periodMatch = text.match(/(?:obdob√≠|period|za obdob√≠):?\\s*([\\d\\.]+\\s*-\\s*[\\d\\.]+)/i);\n  if (periodMatch) {\n    customFields.period = periodMatch[1];\n  }\n  \n  // Pocatecni zustatek\n  const startMatch = text.match(/(?:poƒç√°teƒçn√≠ z≈Østatek|opening balance):?\\s*([\\d\\s]+[,.]?\\d*)\\s*(?:Kƒç|CZK)/i);\n  if (startMatch) {\n    customFields.opening_balance = startMatch[1].replace(/\\s/g, '');\n  }\n  \n  // Konecny zustatek\n  const endMatch = text.match(/(?:koneƒçn√Ω z≈Østatek|closing balance|z≈Østatek):?\\s*([\\d\\s]+[,.]?\\d*)\\s*(?:Kƒç|CZK)/i);\n  if (endMatch) {\n    customFields.closing_balance = endMatch[1].replace(/\\s/g, '');\n  }\n  \n  // Mesic a rok\n  const monthMatch = text.match(/(?:leden|√∫nor|b≈ôezen|duben|kvƒõten|ƒçerven|ƒçervenec|srpen|z√°≈ô√≠|≈ô√≠jen|listopad|prosinec)\\s+\\d{4}/i);\n  if (monthMatch) {\n    tags.push(monthMatch[0].toLowerCase().replace(/\\s+/g, '-'));\n  }\n}\n\n// PARSOVANI PRO UCTENKU\nif (docType === 'uctenka') {\n  // EET kod\n  const eetMatch = text.match(/(?:BKP|FIK):?\\s*([A-Z0-9\\-]+)/i);\n  if (eetMatch) {\n    customFields.eet_code = eetMatch[1];\n  }\n  \n  // Castka\n  const receiptAmountMatch = text.match(/(?:celkem|total|suma):?\\s*([\\d\\s]+[,.]?\\d*)\\s*(?:Kƒç|CZK)/i);\n  if (receiptAmountMatch) {\n    customFields.amount = receiptAmountMatch[1].replace(/\\s/g, '');\n  }\n  \n  // Datum a cas\n  const dateTimeMatch = text.match(/(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})\\s+(\\d{1,2}:\\d{2})/i);\n  if (dateTimeMatch) {\n    customFields.date = dateTimeMatch[1];\n    customFields.time = dateTimeMatch[2];\n  }\n  \n  // Pokladna\n  const cashRegMatch = text.match(/(?:pokladna|kasa|terminal):?\\s*([\\d\\w]+)/i);\n  if (cashRegMatch) {\n    customFields.cash_register = cashRegMatch[1];\n  }\n}\n\n// PARSOVANI PRO SMLOUVU\nif (docType === 'smlouva') {\n  // Cislo smlouvy\n  const contractMatch = text.match(/(?:ƒç√≠slo smlouvy|contract number|ƒç\\.s\\.):?\\s*([A-Z0-9\\-\\/]+)/i);\n  if (contractMatch) {\n    customFields.contract_number = contractMatch[1];\n  }\n  \n  // Datum uzavreni\n  const signDateMatch = text.match(/(?:uzav≈ôeno dne|signed on|datum uzav≈ôen√≠):?\\s*(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})/i);\n  if (signDateMatch) {\n    customFields.sign_date = signDateMatch[1];\n  }\n  \n  // Platnost od\n  const validFromMatch = text.match(/(?:platnost od|valid from|√∫ƒçinnost od):?\\s*(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})/i);\n  if (validFromMatch) {\n    customFields.valid_from = validFromMatch[1];\n  }\n  \n  // Platnost do\n  const validToMatch = text.match(/(?:platnost do|valid to|√∫ƒçinnost do):?\\s*(\\d{1,2}[\\.\\-]\\d{1,2}[\\.\\-]\\d{4})/i);\n  if (validToMatch) {\n    customFields.valid_to = validToMatch[1];\n  }\n}\n\n// OBECNE TAGY\nif (text.match(/2025/)) tags.push('2025');\nif (text.match(/2024/)) tags.push('2024');\nif (text.match(/2023/)) tags.push('2023');\n\nif (textLower.includes('dph') || textLower.includes('vat')) {\n  const vatMatch = text.match(/(\\d{1,2})\\s*%/i);\n  if (vatMatch) {\n    tags.push('dph-' + vatMatch[1]);\n  }\n}\n\nreturn [{json: {\n  status: 'SUCCESS',\n  filename: filename,\n  filepath: filepath,\n  document_type: docType,\n  correspondent: correspondent,\n  tags: [...new Set(tags)], // unique tags\n  custom_fields: customFields,\n  text_length: text.length,\n  preview: text.substring(0, 500)\n}}];"
      },
      "id": "parseDocument",
      "name": "Parse Document",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\n// Priprava custom fields pro Paperless API\nconst customFieldsJson = JSON.stringify(data.custom_fields);\n\nreturn [{json: {\n  filepath: data.filepath,\n  filename: data.filename,\n  title: data.filename.replace('.pdf', ''),\n  document_type: data.document_type,\n  correspondent: data.correspondent,\n  tags: data.tags.join(','),\n  custom_fields_json: customFieldsJson,\n  // Individual custom fields for Paperless\n  invoice_number: data.custom_fields.invoice_number || '',\n  variable_symbol: data.custom_fields.variable_symbol || '',\n  amount: data.custom_fields.amount || '',\n  ico: data.custom_fields.ico || '',\n  dic: data.custom_fields.dic || '',\n  issue_date: data.custom_fields.issue_date || '',\n  due_date: data.custom_fields.due_date || '',\n  account_number: data.custom_fields.account_number || '',\n  period: data.custom_fields.period || '',\n  contract_number: data.custom_fields.contract_number || ''\n}}];"
      },
      "id": "preparePaperless",
      "name": "Prepare for Paperless",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:8050/api/documents/post_document/",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Token 9d51c86467e7b7e17a8748722ff1a24226c94a7e"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "document",
              "parameterType": "formBinaryData",
              "inputDataFieldName": "={{$json.filepath}}"
            },
            {
              "name": "title",
              "value": "={{$json.title}}"
            },
            {
              "name": "correspondent",
              "value": "={{$json.correspondent}}"
            },
            {
              "name": "document_type",
              "value": "={{$json.document_type}}"
            },
            {
              "name": "tags",
              "value": "={{$json.tags}}"
            },
            {
              "name": "custom_fields",
              "value": "={{$json.custom_fields_json}}"
            }
          ]
        },
        "options": {}
      },
      "id": "uploadPaperless",
      "name": "Upload to Paperless",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1600, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const parseData = $node['parseDocument'].json;\nconst uploadResult = $json;\n\nif (parseData.status === 'ERROR') {\n  return [{json: {\n    '‚ùå STATUS': 'EXTRACTION FAILED',\n    'üìÑ File': parseData.filename,\n    '‚ö†Ô∏è Error': parseData.message\n  }}];\n}\n\nif (uploadResult.error) {\n  return [{json: {\n    '‚ö†Ô∏è STATUS': 'UPLOAD FAILED',\n    'üìÑ File': parseData.filename,\n    'üìë Type': parseData.document_type,\n    'üë§ Correspondent': parseData.correspondent,\n    'üè∑Ô∏è Tags': parseData.tags.join(', '),\n    'üìù Custom Fields': JSON.stringify(parseData.custom_fields, null, 2),\n    '‚ùå Upload Error': uploadResult.message || 'Failed to upload to Paperless'\n  }}];\n}\n\nreturn [{json: {\n  '‚úÖ STATUS': 'COMPLETE SUCCESS',\n  'üìÑ File': parseData.filename,\n  'üìë Type': parseData.document_type,\n  'üë§ Correspondent': parseData.correspondent,\n  'üè∑Ô∏è Tags': parseData.tags.join(', '),\n  'üìù Custom Fields': JSON.stringify(parseData.custom_fields, null, 2),\n  'üÜî Paperless ID': uploadResult.id || 'Uploaded',\n  'üìä Text Length': parseData.text_length + ' characters'\n}}];"
      },
      "id": "finalResult",
      "name": "Final Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 300]
    }
  ],
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "List PDFs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List PDFs": {
      "main": [
        [
          {
            "node": "Select File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select File": {
      "main": [
        [
          {
            "node": "Base64 Encode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 Encode": {
      "main": [
        [
          {
            "node": "PDFco Extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDFco Extract": {
      "main": [
        [
          {
            "node": "Parse Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Document": {
      "main": [
        [
          {
            "node": "Prepare for Paperless",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Paperless": {
      "main": [
        [
          {
            "node": "Upload to Paperless",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Paperless": {
      "main": [
        [
          {
            "node": "Final Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "complete_parser"
}